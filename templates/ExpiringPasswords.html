<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expiring Passwords - FinKen</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- Header with Branding -->
    <div class="header">
        <div class="branding">
            <div class="branding-content">
                <img src="{{ url_for('static', filename='images/finkenlogo.png') }}" alt="FinKen Logo" class="logo-image">
                <div class="branding-text">
                    <h1><span class="pocket-text">Pocket</span><span class="watch-text">Watch</span></h1>
                    <p>Financial Accounting App</p>
                </div>
            </div>
        </div>
        <!-- User Header -->
        <div class="user-header">
            <div class="user-info">
                <span class="user-name">{{ user_name }}</span>
                <span class="user-role-badge">{{ user_role.title() }}</span>
            </div>
            <div class="user-profile">
                <img src="{{ url_for('profile_image', filename=user_profile_picture) }}" 
                     alt="Profile Picture" class="profile-image">
            </div>
        </div>
    </div>

    <!-- Navigation Menu -->
    <button class="nav-toggle">Toggle Navigation</button>
    <nav class="navbar">
        <ul class="nav-list">
            <img src="{{ url_for('static', filename='images/finkenlogo.png') }}" alt="FinKen Logo" class="logo-image">
            <li><a href="/Home">Home</a></li>
            <li><a href="/ManageRegistrations">Manage Registrations</a></li>
            <li><a href="/Users">Users</a></li>
            <li class="active"><a href="/ExpiringPasswords">Expiring Passwords</a></li>
            <li><a href="#">Statements</a></li>
            <li><a href="/SignOut">Sign Out</a></li>
        </ul>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <div class="admin-container">
        <h1 class="admin-header">Password Expiry Management</h1>
        
        <div class="expiry-summary">
            <p><strong>{{ total_count }}</strong> users have passwords expiring within the next 30 days.</p>
        </div>

        <!-- Expiring Passwords Table -->
        <div class="requests-table">
            <table id="expiring-passwords-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Password Expiry Date</th>
                        <th>Days Until Expiry</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="{% if user.IsExpired %}expired-row{% elif user.IsExpiringSoon %}expiring-soon-row{% endif %}">
                        <td>{{ user.UserID }}</td>
                        <td>{{ user.Username }}</td>
                        <td>{{ user.FirstName }} {{ user.LastName }}</td>
                        <td>{{ user.Email }}</td>
                        <td>{{ user.RoleName }}</td>
                        <td>{{ user.PasswordExpiryDate[:10] if user.PasswordExpiryDate else 'N/A' }}</td>
                        <td>
                            {% if user.DaysUntilExpiry < 0 %}
                                <span class="expired-text">{{ user.DaysUntilExpiry * -1 }} days ago</span>
                            {% elif user.DaysUntilExpiry == 0 %}
                                <span class="expiring-today-text">Today</span>
                            {% else %}
                                <span class="{% if user.IsExpiringSoon %}expiring-soon-text{% endif %}">{{ user.DaysUntilExpiry }} days</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.IsExpired %}
                                <span class="status-badge status-expired">Expired</span>
                            {% elif user.IsExpiringSoon %}
                                <span class="status-badge status-expiring-soon">Expiring Soon</span>
                            {% else %}
                                <span class="status-badge status-expiring">Expiring</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="btn btn-small btn-primary email-btn" 
                                        data-user-id="{{ user.UserID }}" 
                                        data-email="{{ user.Email }}" 
                                        data-name="{{ user.FirstName }} {{ user.LastName }}"
                                        data-username="{{ user.Username }}">
                                    Send Reminder
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not users %}
            <div class="no-requests">
                <p>ðŸŽ‰ No passwords are expiring in the next 30 days!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Email Modal -->
    <div id="email-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="close-email-modal">&times;</span>
            <h2>Send Password Expiry Reminder</h2>
            <form id="email-form">
                <div class="form-group">
                    <label for="email-recipient">To:</label>
                    <input type="email" id="email-recipient" name="recipient_email" readonly required>
                </div>
                <div class="form-group">
                    <label for="email-subject">Subject:</label>
                    <input type="text" id="email-subject" name="subject" required 
                           value="Password Expiry Reminder - FinKen">
                </div>
                <div class="form-group">
                    <label for="email-message">Message:</label>
                    <textarea id="email-message" name="message" rows="8" required 
                              placeholder="Dear [Name],

Your password for FinKen will expire soon. Please log in and update your password to maintain access to your account.

If you have any questions, please contact your administrator.

Best regards,
FinKen Administration Team"></textarea>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-secondary" id="cancel-email">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Reminder</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Email modal functions
        function showEmailModal(email, name, username) {
            document.getElementById('email-recipient').value = email;
            
            // Pre-fill the message with user-specific content
            const messageTemplate = `Dear ${name},

Your password for FinKen (username: ${username}) will expire soon. Please log in and update your password to maintain access to your account.

To change your password:
1. Log in to FinKen
2. Go to your account settings
3. Update your password

If you have any questions or need assistance, please contact your administrator.

Best regards,
FinKen Administration Team`;
            
            document.getElementById('email-message').value = messageTemplate;
            document.getElementById('email-modal').style.display = 'block';
        }

        function closeEmailModal() {
            document.getElementById('email-modal').style.display = 'none';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Email buttons
            document.querySelectorAll('.email-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const email = this.dataset.email;
                    const name = this.dataset.name;
                    const username = this.dataset.username;
                    showEmailModal(email, name, username);
                });
            });
            
            // Email modal events
            document.getElementById('close-email-modal').addEventListener('click', closeEmailModal);
            document.getElementById('cancel-email').addEventListener('click', closeEmailModal);
            
            // Email form submission
            document.getElementById('email-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = {
                    recipient_email: formData.get('recipient_email'),
                    subject: formData.get('subject'),
                    message: formData.get('message')
                };
                
                try {
                    const response = await fetch('/api/send-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Password reminder sent successfully!');
                        closeEmailModal();
                    } else {
                        alert('Error sending reminder: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error sending reminder:', error);
                    alert('Error sending reminder');
                }
            });
        });

        // Navigation
        document.querySelector('.nav-toggle').addEventListener('click', function() {
            document.querySelector('.navbar').style.left = '0';
        });

        document.querySelector('.navbar').addEventListener('mouseleave', function() {
            document.querySelector('.navbar').style.left = '-250px';
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const emailModal = document.getElementById('email-modal');
            if (event.target === emailModal) {
                closeEmailModal();
            }
        }
    </script>
</body>
</html>